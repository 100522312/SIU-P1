<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarma de Proximidad GPS</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Aseguramos que el mapa ocupe toda la pantalla del dispositivo m贸vil */
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 3. Inicializar el mapa
        // Lo centramos inicialmente en una coordenada por defecto (Madrid en este caso)
        const map = L.map('map').setView([40.4168, -3.7038], 13);

        // A帽adir la capa de mapa (tiles) de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '漏 OpenStreetMap'
        }).addTo(map);

        // Variables para guardar las posiciones y marcadores
        let destinationLatLng = null;
        let destinationMarker = null;
        let userMarker = null;
        let hasBeenNotified = false; // Para no enviar notificaciones infinitas

        // 4. Capturar clics/toques en la pantalla
        map.on('click', function(e) {
            destinationLatLng = e.latlng;
            hasBeenNotified = false; // Reseteamos la notificaci贸n al cambiar de destino

            // Si ya hay un marcador de destino, lo movemos. Si no, lo creamos.
            if (destinationMarker) {
                destinationMarker.setLatLng(destinationLatLng);
            } else {
                // Creamos un marcador rojo (usando un icono por defecto modificado)
                destinationMarker = L.marker(destinationLatLng).addTo(map)
                    .bindPopup("<b>Destino fijado</b>").openPopup();
            }
            console.log("Destino fijado en:", destinationLatLng);
        });

        // 5. Acceder a los sensores del dispositivo (Geolocalizaci贸n)
        if ('geolocation' in navigator) {
            // watchPosition rastrea el movimiento del usuario continuamente
            navigator.geolocation.watchPosition(function(position) {
                const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);

                // Actualizar o crear el marcador del usuario (un c铆rculo azul)
                if (userMarker) {
                    userMarker.setLatLng(userLatLng);
                } else {
                    userMarker = L.circleMarker(userLatLng, {
                        color: 'blue', 
                        radius: 8,
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup("Tu ubicaci贸n");
                    
                    // Centrar el mapa en el usuario la primera vez que lo detecta
                    map.setView(userLatLng, 15);
                }

                // 6. L贸gica de proximidad y notificaci贸n
                if (destinationLatLng && !hasBeenNotified) {
                    // Leaflet tiene un m茅todo s煤per 煤til para calcular distancia en metros
                    const distance = userLatLng.distanceTo(destinationLatLng);
                    
                    // Si estamos a menos de 50 metros, lanzamos la notificaci贸n
                    if (distance < 50) {
                        hasBeenNotified = true; // Evitar que salte la alerta cada segundo
                        
                        alert(" 隆Has llegado o est谩s muy cerca de tu destino!");
                        
                        // Opcional: Intentar usar la API de Notificaciones del sistema
                        if (Notification.permission === "granted") {
                            new Notification("隆Destino alcanzado!");
                        } else if (Notification.permission !== "denied") {
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    new Notification("隆Destino alcanzado!");
                                }
                            });
                        }
                    }
                }
            }, function(error) {
                console.error("Error obteniendo ubicaci贸n:", error);
            }, {
                enableHighAccuracy: true, // Pedimos la mayor precisi贸n al GPS
                maximumAge: 0
            });
        } else {
            alert("Tu navegador no soporta geolocalizaci贸n.");
        }
    </script>
</body>
</html>